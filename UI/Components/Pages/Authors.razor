@page "/authors"
@rendermode InteractiveServer
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using mass.Data

@inject MassDbContext DbContext
@inject ILogger<Authors> Logger

<PageTitle>Authors</PageTitle>

<h1>Authors</h1>

<div class="mb-3">
    <div class="input-group">
        <input type="text" class="form-control" placeholder="Search by username..." @bind="SearchQuery" @bind:after="OnSearchChanged" />
    </div>
</div>

@if (Loading)
{
    <p><em>Loading...</em></p>
}
else if (FoundAuthors is null || !FoundAuthors.Any())
{
    <div class="alert alert-info">No authors found.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Username</th>
                    <th>Contributable Stories</th>
                    <th>Entries</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var author in FoundAuthors)
                {
                    <tr>
                        <td>@author.UserName</td>
                        <td>@author.ContributableStoriesCount</td>
                        <td>@author.EntryCount</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Paging Controls -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item @(CurrentPage <= 1 ? "disabled" : "")">
                <button class="page-link" @onclick="() => GoToPage(CurrentPage - 1)" disabled="@(CurrentPage <= 1)">
                    Previous
                </button>
            </li>

            @for (int i = 1; i <= TotalPages; i++)
            {
                int pageNum = i;
                <li class="page-item @(CurrentPage == pageNum ? "active" : "")">
                    <button class="page-link" @onclick="() => GoToPage(pageNum)">
                        @pageNum
                    </button>
                </li>
            }

            <li class="page-item @(CurrentPage >= TotalPages ? "disabled" : "")">
                <button class="page-link" @onclick="() => GoToPage(CurrentPage + 1)" disabled="@(CurrentPage >= TotalPages)">
                    Next
                </button>
            </li>
        </ul>
    </nav>

    <div class="text-center text-muted mt-2">
        Page @CurrentPage of @TotalPages (Total: @TotalCount authors)
    </div>
}

@code {
    private List<AuthorViewModel>? FoundAuthors;
    private string SearchQuery = "";
    private int CurrentPage = 1;
    private int PageSize = 10;
    private int TotalCount = 0;
    private bool Loading = true;

    private int TotalPages => (TotalCount + PageSize - 1) / PageSize;

    private class AuthorViewModel
    {
        public required string UserName { get; set; }
        public int ContributableStoriesCount { get; set; }
        public int EntryCount { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadAuthors();
    }

    private async Task OnSearchChanged()
    {
        CurrentPage = 1;
        await LoadAuthors();
    }

    private async Task GoToPage(int pageNumber)
    {
        if (pageNumber < 1 || pageNumber > TotalPages)
            return;

        CurrentPage = pageNumber;
        await LoadAuthors();
    }

    private async Task LoadAuthors()
    {
        Loading = true;
        try
        {
            var query = DbContext.MassIdentityUsers
                .Include(u => u.CreatedStories)
                .Include(u => u.ContributedStories)
                .AsNoTracking();

            // Apply search filter if provided
            if (!string.IsNullOrEmpty(SearchQuery))
            {
                query = query.Where(u => u.UserName != null && u.UserName.ToLower().Contains(SearchQuery.ToLower()));
            }

            // Count before paging
            TotalCount = await query.CountAsync();

            // Apply paging and create view models
            FoundAuthors = await query
                .OrderBy(u => u.UserName)
                .Skip((CurrentPage - 1) * PageSize)
                .Take(PageSize)
                .Select(u => new AuthorViewModel
                {
                    UserName = u.UserName ?? "Unknown",
                    ContributableStoriesCount = u.CreatedStories.Count + u.ContributedStories.Count,
                    EntryCount = u.CreatedEntries.Count
                })
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading authors");
            FoundAuthors = new List<AuthorViewModel>();
        }
        finally
        {
            Loading = false;
        }
    }
}
