@page "/"

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using mass.Data

@inject MassDbContext DbContext
@inject UserManager<MassIdentityUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Home</PageTitle>
 <img src="/images/writers.jpg" alt="Writers collaborating" class="img-fluid mb-4 rounded" />
<AuthorizeView>
    <Authorized>
        <h1>Welcome back writer!</h1>
        @if (lastEditedStory != null)
        {
            <p>
                Would you like to keep working on <a href="/stories/edit/@lastEditedStory.Id"><strong>@lastEditedStory.Title</strong></a>? Or would you rather <a href="/stories">work on something else</a>?
            </p>
        }
        else
        {
            <p>
                Go to the <a href="/stories">Stories</a> page to manage and contribute to your stories.
            </p>
        }
    </Authorized>
    <NotAuthorized>
        <h1>MASS — the Multi-Author Story System!</h1>

        <p class="lead">MASS lets people collaborate to write stories together — create stories and chapters, invite contributors, and build multi-author narratives with simple tools.</p>

        <ul>
            <li><strong>Create</strong> stories, chapters, and entries</li>
            <li><strong>Collaborate</strong> with contributors and manage access</li>
            <li><strong>Publish</strong> and share finished stories</li>
        </ul>

        <p>Ready to get started?</p>

        <a class="btn btn-primary" href="/Account/Login">Sign in</a>
        <a class="btn btn-outline-primary ms-2" href="/stories/public">Explore Public Stories</a>
    </NotAuthorized>
</AuthorizeView>

@code {
    private Story? lastEditedStory;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            var currentUser = await UserManager.GetUserAsync(user);
            if (currentUser != null)
            {
                lastEditedStory = await DbContext.Stories
                    .Where(s => s.Chapters.Any(c => c.Entries.Any(e => e.CreatedBy.Id == currentUser.Id)))
                    .OrderByDescending(s => s.Chapters.Max(c => c.Entries.Max(e => e.LastModifiedAt)))
                    .FirstOrDefaultAsync();
            }
        }
    }
}