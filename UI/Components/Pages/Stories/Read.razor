@page "/stories/read/{Id:int}"

@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using mass.Data
@inject MassDbContext DbContext
@inject NavigationManager NavigationManager
@inject ILogger<Read> Logger
@inject UserManager<MassIdentityUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider

@attribute [Layout(typeof(MainLayout))]

@if (IsLoading)
{
    <p><em>Loading...</em></p>
}
else if (Story is null)
{
    <p class="alert alert-warning">Story not found.</p>
}
else
{
    <article class="reading-mode">
        <header>
            @if (!Story.IsPublic && IsContributor)
            {
                <div class="alert alert-info" role="alert">
                    <strong>Note:</strong> This story is not public, but you can read it because you are a contributor.
                </div>
            }
            <h1>@Story.Title</h1>
            <p class="lead">@Story.Description</p>
            <p class="text-muted">Last modified @Story.LastModifiedAt.ToLocalTime().ToString("g")</p>
            <p class="text-muted">Contributors: @string.Join(", ", authors)</p>
            <hr />
        </header>

        @foreach (var chapter in Story.Chapters.OrderBy(c => c.Order))
        {
            <section class="chapter">
                <h2>@chapter.Title</h2>
                @foreach (var entry in chapter.Entries.OrderBy(e => e.Order))
                {
                    <div class="entry">
                        <p>@entry.Content</p>
                    </div>
                }
            </section>
        }
    </article>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Story? Story;
    private List<string> authors = new();
    private bool IsLoading = true;
    private bool IsContributor = false;

    protected override async Task OnParametersSetAsync()
    {
        IsLoading = true;
        IsContributor = false;

        try
        {
            Story = await DbContext.Stories
                .Include(s => s.CreatedBy)
                .Include(s => s.Contributors)
                .Include(s => s.Chapters)
                    .ThenInclude(c => c.Entries)
                .AsNoTracking()
                .FirstOrDefaultAsync(s => s.Id == Id);

            if (Story is null)
            {
                // Story not found
                NavigationManager.NavigateTo("/not-found");
                return;
            }

            // Check if user is a contributor
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = await UserManager.GetUserAsync(authState.User);

            if (user is not null)
            {
                IsContributor = Story.CreatedBy.Id == user.Id || Story.Contributors.Any(c => c.Id == user.Id);
            }

            // Only allow access if story is public OR user is a contributor
            if (!Story.IsPublic && !IsContributor)
            {
                NavigationManager.NavigateTo("/not-found");
                return;
            }

            authors.AddRange(Story
                .Contributors
                .Where(c => !string.IsNullOrEmpty(c.UserName))
                .Select(c => c.UserName!)
                .ToList());

            authors.Insert(0, Story.CreatedBy.UserName!);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading story {StoryId}", Id);
            NavigationManager.NavigateTo("/not-found");
            return;
        }
        finally
        {
            IsLoading = false;
        }
    }
}
